<!DOCTYPE html>
<html lang="hr">
    <head>
        <meta charset="UTF-8">
        <title>Fitness AI Asistent</title>
        <link rel="stylesheet" href="/css/mainpage.css">
    </head>
    <body>
        <nav class="menu">
            <div class="menu-left" id="userDisplay"></div>
            <ul>
                <li><a id="profileLink" href="#">Uredi profil</a></li>
                <li><a id="routinesLink" href="#">Rutine</a></li>
                <li><a id="logoutLink" href="#">Odjava</a></li>
            </ul>
        </nav>

        <div class="user-stats" id="userStats">
            <h3>Tjelesni podaci</h3>
        </div>

        <div class="container">
            <h1 id="welcome-message">Dobrodošao u Fitness AI Asistenta.</h1>

            <div class="chat-box">
                <div id="chatMessages" class="chat-messages"></div>

                <div class="input-area">
                    <textarea id="questionInput" placeholder="Postavi pitanje AI asistentu..."></textarea>
                    <button id="sendButton">Pošalji</button>
                </div>
            </div>
        </div>

        <div class="routines-container">
            <div class="training-box">

            </div>
        </div>

        <script>
            function getUserIdFromURL() {
                const params = new URLSearchParams(window.location.search);
                return params.get("userId");
            }

            const userId = getUserIdFromURL();

            if (!userId) {
                alert("Nedostaje userId! Prijavite se ponovno.");
                window.location.href = "/";
            }

            const profileLink = document.getElementById("profileLink");
            profileLink.href = `/profile?userId=${userId}`;

            document.getElementById("routinesLink").href = `/routines?userId=${userId}`;

            const logoutLink = document.getElementById("logoutLink");
            logoutLink.href = `/?userId=${userId}`;

            document.getElementById("sendButton").addEventListener("click", async () => {
                const question = document.getElementById("questionInput").value.trim();
                if(!question) return;

                const chatMessages = document.getElementById("chatMessages");

                try{
                    const userRes = await fetch(`/api/users/${userId}`);
                    const userData = await userRes.json();

                    const userName = userData.name || "Ti";

                    chatMessages.innerHTML += `<div class="message user"><strong>${userName}:</strong> ${question}</div>`;
                    document.getElementById("questionInput").value = "";
                    const aiRes = await fetch(`/api/ai-chat`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({userData, question})
                });

                const aiData = await aiRes.json();
                chatMessages.innerHTML += `<div class="message ai"><strong>Arnold AI:</strong> ${aiData.answer}</div>`;
                chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (err) {
                    chatMessages.innerHTML += `<div class="message error">Greška pri komunikaciji s asistentom.</div>`;
                    console.error("AI greška:", err);
                }
            });

            (async () => {
                try {
                    const userRes = await fetch(`/api/users/${userId}`);
                    const userData = await userRes.json();

                    const userName = userData.name || "Korisnik";

                    // Prikaži ime korisnika u meniju
                    document.getElementById("userDisplay").textContent = `Korisnik: ${userName}`;

                    // Prikaži tjelesne podatke dinamički
                    const userStatsDiv = document.getElementById("userStats");
                    userStatsDiv.innerHTML = `
                        <h3>Statistika</h3>
                        <p><strong>Visina:</strong> ${userData.height} cm</p>
                        <p><strong>Težina:</strong> ${userData.weight} kg</p>
                        <p><strong>Godine:</strong> ${userData.age}</p>
                        <p><strong>Preporučen unos kalorija:</strong> ${Math.round(userData.caloricIntake)} kcal</p>
                    `;
                } catch (e) {
                    console.error("Ne mogu dohvatiti korisničke podatke:", e);
                }
            })();
        </script>
    </body>
</html>